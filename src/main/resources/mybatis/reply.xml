<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.mvc.reply.ReplyDAOInter">

  <!-- 댓글 등록 (일반 + 대댓글 포함) -->
  <insert id="create" parameterType="dev.mvc.reply.ReplyVO">
  INSERT INTO reply (
    reply_no, content, created_day, post_no, user_no, parent_reply_no
    ) VALUES (
    reply_seq.NEXTVAL, #{content}, SYSDATE, #{post_no}, #{user_no}, #{parent_reply_no, jdbcType=INTEGER} <!--dbcType=INTEGER로 명시하면, Oracle이 “숫자인데 null” 하고 이해함.-->
    )
  </insert>
  
  <!--명시적 resultMap 사용-->
  <resultMap id="ReplyMap" type="dev.mvc.reply.ReplyVO">
  <result property="reply_no"      column="reply_no"/>
  <result property="content"       column="content"/>
  <result property="created_day"   column="created_day"/>
  <result property="post_no"       column="post_no"/>
  <result property="user_no"       column="user_no"/>
  <result property="parent_reply_no" column="parent_reply_no"/>
  <result property="user_id"       column="user_id"/>
  <result property="userName"      column="user_name"/> 
</resultMap>

  <!-- 게시글에 달린 댓글 + 대댓글 조회 -->
  <select id="list_by_post" resultMap="ReplyMap" parameterType="int">
  SELECT 
    r.*, 
    u.user_id,
    u.name      AS user_name   
    FROM reply r
    JOIN users u ON r.user_no = u.user_no
    WHERE r.post_no = #{post_no}
    ORDER BY NVL(r.parent_reply_no, r.reply_no), r.reply_no
  </select>

  <!-- 내가 쓴 댓글 목록 조회 -->
  <select id="list_by_user" resultType="dev.mvc.reply.ReplyVO">
    SELECT r.*, p.title AS post_title
    FROM reply r
    JOIN post p ON r.post_no = p.post_no
    WHERE r.user_no = #{user_no}
    ORDER BY r.created_day DESC
  </select>

  <!-- 댓글 수정 -->
  <update id="update" parameterType="dev.mvc.reply.ReplyVO">
    UPDATE reply
    SET content = #{content}
    WHERE reply_no = #{reply_no}
  </update>

  <!-- 댓글 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM reply WHERE reply_no = #{reply_no}
  </delete>

  <!-- 댓글 1건 조회 -->
  <select id="read" resultType="dev.mvc.reply.ReplyVO">
    SELECT * FROM reply WHERE reply_no = #{reply_no}
  </select>

</mapper>
