<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.mvc.bookmark.BookmarkDAOInter">

  <!-- ðŸŽ¯ ì—¬í–‰ì§€ ì¦ê²¨ì°¾ê¸° ë“±ë¡ -->
  <insert id="create_trip" parameterType="dev.mvc.bookmark.BookmarkVO">
    INSERT INTO bookmark (bookmark_no, trip_no, user_no)
    VALUES (bookmark_seq.NEXTVAL, #{trip_no}, #{user_no})
  </insert>

  <!-- ðŸŽ¯ ê²Œì‹œê¸€ ì¦ê²¨ì°¾ê¸° ë“±ë¡ -->
  <insert id="create_post" parameterType="dev.mvc.bookmark.BookmarkVO">
    INSERT INTO bookmark (bookmark_no, post_no, user_no)
    VALUES (bookmark_seq.NEXTVAL, #{post_no}, #{user_no})
  </insert>

  <!-- ðŸ“‹ ì‚¬ìš©ìž ì¦ê²¨ì°¾ê¸° ëª©ë¡ (ì›ë³¸ VO ê¸°ì¤€) -->
  <select id="list_by_user" resultType="dev.mvc.bookmark.BookmarkVO">
    SELECT * FROM bookmark
    WHERE user_no = #{user_no}
    ORDER BY bookmark_no DESC
  </select>

  <!-- ðŸ” ì¤‘ë³µ í™•ì¸ (ì—¬í–‰ì§€) -->
  <select id="check_duplicate_trip" parameterType="hashmap" resultType="int">
    SELECT COUNT(*) FROM bookmark
    WHERE user_no = #{user_no} AND trip_no = #{trip_no}
  </select>

  <!-- ðŸ” ì¤‘ë³µ í™•ì¸ (ê²Œì‹œê¸€) -->
  <select id="check_duplicate_post" parameterType="hashmap" resultType="int">
    SELECT COUNT(*) FROM bookmark
    WHERE user_no = #{user_no} AND post_no = #{post_no}
  </select>

  <!-- âŒ ì‚­ì œ (ì—¬í–‰ì§€) -->
  <delete id="delete_by_user_and_trip" parameterType="dev.mvc.bookmark.BookmarkVO">
    DELETE FROM bookmark
    WHERE user_no = #{user_no} AND trip_no = #{trip_no}
  </delete>

  <!-- âŒ ì‚­ì œ (ê²Œì‹œê¸€) -->
  <delete id="delete_by_user_and_post" parameterType="dev.mvc.bookmark.BookmarkVO">
    DELETE FROM bookmark
    WHERE user_no = #{user_no} AND post_no = #{post_no}
  </delete>

  <!-- ðŸ”— ì‚¬ìš©ìžë³„ ì¦ê²¨ì°¾ê¸° ëª©ë¡ (JOIN: ì—¬í–‰ì§€ + ê²Œì‹œê¸€) -->
  <select id="list_join_by_user" resultType="dev.mvc.bookmark.BookmarkJoinVO">
    SELECT 
      b.bookmark_no,
      u.user_no,
      u.name AS user_name,
  
      -- íƒ€ìž… êµ¬ë¶„
      CASE 
        WHEN b.trip_no IS NOT NULL THEN 'trip'
        WHEN b.post_no IS NOT NULL THEN 'post'
        ELSE 'unknown'
      END AS type,
  
      -- ì—¬í–‰ì§€ ê´€ë ¨ ì»¬ëŸ¼ (LEFT JOIN)
      t.trip_no,
      t.tname AS trip_title,
      t.sname,
      t.image,
      t.intro,
      t.tnew,
      t.viewcnt,
  
      -- ê²Œì‹œê¸€ ê´€ë ¨ ì»¬ëŸ¼ (LEFT JOIN)
      p.post_no,
      p.title AS post_title,
      p.created_day
  
    FROM bookmark b
      JOIN users u ON b.user_no = u.user_no
      LEFT JOIN trip t ON b.trip_no = t.trip_no
      LEFT JOIN post p ON b.post_no = p.post_no
  
    WHERE b.user_no = #{user_no}
    ORDER BY b.bookmark_no DESC
  </select>


</mapper>
