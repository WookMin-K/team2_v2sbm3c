<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.mvc.users.UsersDAOInter">

  <!--  ID 중복 확인 -->
  <select id="checkID" parameterType="string" resultType="int">
    SELECT COUNT(user_id)
    FROM users
    WHERE user_id = #{user_id}
  </select>

  <!-- 이메일 중복 확인 -->
  <select id="checkEmail" parameterType="string" resultType="int">
    SELECT COUNT(email)
    FROM users
    WHERE email = #{email}
  </select>


  <!-- 회원 등록 -->
  <insert id="create" parameterType="dev.mvc.users.UsersVO">
    INSERT INTO users (
    user_no, user_id, password, email, name, phone, created_at, grade
    )
    VALUES (
    users_seq.nextval, #{user_id}, #{password}, #{email}, #{name}, #{phone},
    SYSDATE, #{grade}
    )
  </insert>

  <!-- 회원 전체 목록 조회 -->
  <select id="list" resultType="dev.mvc.users.UsersVO">
    SELECT user_no, user_id, password, email, name, phone, created_at, grade
    FROM users
    ORDER BY grade ASC, user_id ASC
  </select>

  <!-- 회원번호로 회원 정보 조회 -->
  <select id="read" parameterType="int" resultType="dev.mvc.users.UsersVO">
    SELECT user_no, user_id, password, email, name, phone, created_at, grade
    FROM users
    WHERE user_no = #{user_no}
  </select>

  <!-- 아이디로 회원 정보 조회 -->
  <select id="readById" parameterType="string" resultType="dev.mvc.users.UsersVO">
    SELECT user_no, user_id, password, email, name, phone, created_at, grade
    FROM users
    WHERE user_id = #{user_id}
  </select>

  <!-- 사용자 정보 수정
  <update id="update" parameterType="dev.mvc.users.UsersVO">
    UPDATE users
    SET password = #{password},
        email = #{email},
        name = #{name},
        phone = #{phone},
        grade = #{grade}
    WHERE user_id = #{user_id}
  </update>
   -->
  <!-- 사용자 정보 개별 수정 -->
  <update id="update_User" parameterType="dev.mvc.users.UsersVO">
    UPDATE users
    <set>
      <if test="password != null">password = #{password},</if>
      <if test="email != null">email = #{email},</if>
      <if test="name != null">name = #{name},</if>
      <if test="phone != null">phone = #{phone},</if>
      <if test="grade != null">grade = #{grade},</if>
    </set>
    WHERE user_id = #{user_id}
  </update>

  <!--  사용자 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM users
    WHERE user_no = #{user_no}
  </delete>

  <!-- 비밀번호 해시값 가져오기 -->
  <select id="getHashedPassword" parameterType="int" resultType="String">
    SELECT password
    FROM users
    WHERE user_no = #{user_no}
  </select>

  <!--  비밀번호 변경 -->
  <update id="passwd_update" parameterType="hashmap">
    UPDATE users
    SET password = #{password}
    WHERE user_no = #{user_no}
  </update>

  <!-- JOIN된 즐겨찾기 목록 조회 -->
  <select id="list_join_by_user" resultType="dev.mvc.bookmark.BookmarkJoinVO" parameterType="int">
    SELECT b.bookmark_no, b.user_no, u.name AS user_name,
    b.spot_no, s.title AS spot_title
    FROM bookmark b
    JOIN users u ON b.user_no = u.user_no
    JOIN spot s ON b.spot_no = s.spot_no
    WHERE b.user_no = #{user_no}
    ORDER BY b.bookmark_no DESC
  </select>

  <select id="checkSnsId" parameterType="string" resultType="int">
    SELECT COUNT(*)
    FROM USERS_SNS
    WHERE PROVIDER_NO = #{provider_no}
  </select>


  <select id="readByEmail" parameterType="string" resultType="dev.mvc.users.UsersVO">
    SELECT *
    FROM USERS
    WHERE EMAIL = #{email}
  </select>

<!-- 회원 목록 페이징 + 검색 -->
<select id="listWithPaging" parameterType="map" resultType="dev.mvc.users.UsersVO">
  SELECT user_no, user_id, email, name, grade, created_at
  FROM users
  <where>
    <if test="keyword != null and keyword != ''">
      (user_id LIKE '%' || #{keyword} || '%'
      OR name LIKE '%' || #{keyword} || '%'
      OR email LIKE '%' || #{keyword} || '%')
    </if>
  </where>
  ORDER BY user_no DESC
  OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
</select>

<!-- 총 회원수 (검색용, 페이징에 필요) -->
<select id="countAll" parameterType="map" resultType="int">
  SELECT COUNT(*)
  FROM users
  <where>
    <if test="keyword != null and keyword != ''">
      (user_id LIKE '%' || #{keyword} || '%'
      OR name LIKE '%' || #{keyword} || '%'
      OR email LIKE '%' || #{keyword} || '%')
    </if>
  </where>
</select>



</mapper>


